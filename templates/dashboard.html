<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FYP ICU Manager Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 2rem; }
    h1 { text-align: center; color: #333; }
    .section { margin-bottom: 2rem; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: center; }
    th { background: #f0f0f0; }
    canvas { background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .status-true { color: green; font-weight: bold; }
    .status-false { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>🧠 FYP ICU Manager Dashboard</h1>

  <div class="section">
    <h2>🛠️ Container Status</h2>
    <div id="status-tables"></div>
  </div>

  <div class="section">
    <h2>🌐 Master/Standby Roles</h2>
    <div id="roles"></div>
  </div>

  <div class="section">
    <h2>📊 Live Metrics</h2>
    <canvas id="heartbeatChart" width="800" height="300"></canvas>
    <canvas id="messageFlowChart" width="800" height="300" style="margin-top:2rem;"></canvas>
  </div>

  <div class="section">
    <h2>📓 Promotion History</h2>
    <ul id="promotion-log"></ul>
  </div>

  <script>
    async function fetchData() {
      const res = await fetch('/api/status');
      const data = await res.json();
      renderTables(data);
      renderRoles(data);
      updateHeartbeatChart();
      updateMessageFlowChart();
      updatePromotionLog();
    }

    function renderTables(data) {
      const section = document.getElementById('status-tables');
      section.innerHTML = '';
      for (const [category, status] of Object.entries(data)) {
        if (typeof status === 'object' && !Array.isArray(status)) {
          const table = document.createElement('table');
          const thead = `<thead><tr><th>${category}</th><th>Status</th></tr></thead>`;
          const tbody = Object.entries(status)
            .map(([k,v]) => `<tr><td>${k}</td><td class="status-${v}">${v}</td></tr>`) 
            .join('');
          table.innerHTML = thead + `<tbody>${tbody}</tbody>`;
          section.appendChild(table);
        }
      }
    }

    function renderRoles(data) {
      const section = document.getElementById('roles');
      section.innerHTML = `
        <p><strong>Master:</strong> consumerMaster.py (${data.consumers['consumerMaster.py']} processes)</p>
        <p><strong>Standby1:</strong> consumerStandby1.py (${data.consumers['consumerStandby1.py']} processes)</p>
        <p><strong>Standby2:</strong> consumerStandby2.py (${data.consumers['consumerStandby2.py']} processes)</p>
      `;
    }

    let heartbeatChart;
    let messageFlowChart;

    async function updateHeartbeatChart() {
      const res = await fetch('/api/heartbeat_log');
      const logs = await res.json();

      const labels = logs.map(entry => entry.timestamp);
      const values = logs.map(entry => entry.master_alive ? 1 : 0);

      if (!heartbeatChart) {
        const ctx = document.getElementById('heartbeatChart').getContext('2d');
        heartbeatChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Master Heartbeat',
              data: values,
              borderColor: 'green',
              fill: false
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true, max: 1 } } }
        });
      } else {
        heartbeatChart.data.labels = labels;
        heartbeatChart.data.datasets[0].data = values;
        heartbeatChart.update();
      }
    }

    async function updateMessageFlowChart() {
      const res = await fetch('/api/message_flow');
      const stats = await res.json();

      const ctx = document.getElementById('messageFlowChart').getContext('2d');
      if (!messageFlowChart) {
        messageFlowChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(stats),
            datasets: [{
              label: 'Messages per Minute',
              data: Object.values(stats),
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      } else {
        messageFlowChart.data.labels = Object.keys(stats);
        messageFlowChart.data.datasets[0].data = Object.values(stats);
        messageFlowChart.update();
      }
    }

    async function updatePromotionLog() {
      const res = await fetch('/api/promotions');
      const logs = await res.json();
      const ul = document.getElementById('promotion-log');
      ul.innerHTML = logs.map(e => `<li><strong>${e.standby}</strong> promoted at ${e.timestamp}</li>`).join('');
    }

    // Auto-refresh every 5 seconds
    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>